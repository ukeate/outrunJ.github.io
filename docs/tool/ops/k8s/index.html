<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  常用
  #


  查看
  #

系统日志
    journalctl -u kubelet | tail
    kubectl api-resources --verbs=list --namespaced -o name   | xargs -n 1 kubectl get --show-kind --ignore-not-found -nmdw
日志
    kubectl logs -f --since=5m --all-containers=true -lapp=[svcName] -o wide
    kubectl get pod [podName] -o yaml
    kubectl get pods -nmdw-log -l app=logstash-logstash -w    # 等待启动
    kubectl describe pods [podName]
    kubectl rollout status deploy/[deployName]          # 查升级记录
    kubectl get events -njnc
        -oyaml
        --field-selector=type=Normal            # Normal, Warning
查ns所有资源
    kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -nairflow
查节点详情
    kubectl get nodes -o json
查扩缩状态
    kubectl rollout status deploy/[deployName]
查所有nodeport
    kubectl get svc --all-namespaces -o go-template=&#39;{{range .items}}{{range.spec.ports}}{{if .nodePort}}{{.nodePort}}{{&quot;\n&quot;}}{{end}}{{end}}{{end}}&#39;


  操作
  #

进容器
    kubectl exec -it [podName]  -- /bin/bash
    kubectl attach [podName]            # 进入主进程IO
用busybox运行命令
    kubectl run -it --image busybox -n [nameSpace] [name] --restart=Never --rm


  监控
  #

kubectl top node -l app=app1
kubectl top pod -nmdw --containers
kubectl describe PodMetrics p1 -njnc-dev


  编辑
  #

kubectl apply -f a.yml
envsubst &lt; jnc.yml |kubectl apply -f -
kubectl label ns jnc istio-injection=enabled --overwrite
kubectl label ns jnc istio-injection-


  亲和性
  #

kubectl get nodes --show-labels
kubectl label nodes node1 deploy=mdw
kubectl taint nodes node1 key=value:NoSchedule                      # NoSchedule、PreferNoSchedule、NoExecute


  调试
  #

kubectl proxy --port=8080 &amp;
    # 以非https形式暴露api
kubectl debug a1 -it --image=yauritux/busybox-curl --share-processes --copy-to=a1-debug
    # 嫁接
kubectl run -it --rm test --image=a:0.1.0 --command -- /bin/bash
    # 改镜像命令
kubectl run -it --rm  busybox1 --image=yauritux/busybox-curl -- /bin/bash
    # 同环境busybox
kubectl cp dir1 ns1/po1:/dir1 -c c1


  清理
  #

删除Evicted/OutOfmemory pod
    kubectl get po -njnc-dev | grep OutOfmemory |awk &#39;{print$1}&#39; | tr &#39;\n&#39; &#39;&#39; | xargs kubectl delete pod -njnc-dev
强制删除pod
    kubectl delete po -nmdw --force --grace-period=0
删除pv/pvc
    kubectl patch pv mdw-mysql-data -p &#39;{&quot;metadata&quot;:{&quot;finalizers&quot;:null}}&#39;
重建pv
    kubectl get pvc p1 -o yaml &gt; a.yml
    编辑a.yml
    kubectl apply -f a.yml
删除node
    kubectl drain node1
维护node不可调度与恢复
    kubectl cordon node1
    kubectl uncordon node1
强制删除ns
    kubectl get ns n1 -o json &gt;tmp.json
    删除finalizers列表
    kubectl proxy
    curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/n1/finalize


  操作
  #

升级镜像
    kubectl set image deploy/[deployName] [imageName]=[imageName:Version]
    kubectl edit deploy/[deployName]
扩容
    kubectl scale deployment [deployName] --replicas=3
    kubectl patch deployment [deployName] -p &#39;{&quot;spec&quot;:{&quot;replicas&quot;:3}}&#39;
重启
    kubectl rollout restart deploy xxx
回滚
    kubectl rollout undo deploy xxx
打污点
    kubectl taint nodes node1 key1=a:NoExecute
        # 添加
    kubectl taint nodes --all key1-
        # 删除
打标签
    kubectl label nodes node1 a=b


  容器配置
  #

HTTPS
    openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout tls.key -out tls.crt -subj &quot;/CN=my-domain.com&quot;
    kubectl create secret tls my-domain-com-tls --cert=tls.crt --key=tls.key --namespace=allure-docker-service
    ingress.yml
        spec:
            tls:
            - secretName: my-domain-com-tls
              hosts:
                - my-domain.com
              
部署.docker/config.json成secret
    kubectl create secret generic regcred --from-file=.dockerconfigjson=&lt;path/to/.docker/config.json&gt; --type=kubernetes.io/dockerconfigjson
配置私有仓库
    kubectl delete secret local
    kubectl -n iot create secret docker-registry local1 \
    --docker-server=192.168.99.1:5000 \
    --docker-username=outrun \
    --docker-password=asdf \
    --docker-email=934260428@qq.com
连阿里云k8s
    kubectl config set-cluster mrs --server=https://106.14.49.217:6443 --certificate-authority=/home/outrun/scripts/work/mrs-k8s/crt --embed-certs=true
    kubectl config set-context 297351062922226746-cdf45d630b2284f8ab79bea186c161d9f --cluster=mrs --user=297351062922226746 --namespace=lora-app
    kubectl config use-context 297351062922226746-cdf45d630b2284f8ab79bea186c161d9f
    kubectl config set-credentials 297351062922226746  --user=297351062922226746 --client-key=/home/outrun/scripts/work/mrs-k8s/297351062922226746.key.pem --client-certificate=/home/outrun/scripts/work/mrs-k8s/297351062922226746.crt --embed-certs=true


  集群配置
  #

设置当前集群namespace
    kubectl config set-context $(kubectl config current-context) --namespace=default
配置DNS解析
    kubectl edit configmap coredns -n kube-system
        apiVersion: v1
        data:
        Corefile: |
            .:53 {
                errors
                hosts {
                    192.168.1.107 a.b.com
                }
            }
    kubectl rollout restart deploy coredns -n kube-system


  文件目录
  #

/etc/kubernetes
/etc/resolve.conf


  命令
  #


  kubeadm
  #

kubeadm init


  kubectl
  #

全局参数
    --help                  # -h
    --output=&quot;jsonpath={.data.\.dockerconfigjson}&quot;
    --output=yaml
    --context=iot
    --namespace=iot 
    --all-namespaces=true
    -n [namespace] 
    --all                           # 如匹配所有deploy文件
Other Commands
    api-resources           # 查所有resource
        namespace/ns
        endpoints/ep
        nodes/no
        configmap/cm  
        replicationcontrollers/rc
        deployments/deploy
        statefulsets/sts
        service/svc 
        ingresses/ing
        persistentvolumes/pv
        persistentvolumeclaims/pvc
        storageclasses/sc
        pods/po
        cronjobs/cj
        daemonset/ds                    # 每个node运行一个
        certificatesigningrequests/csr  # csr证书
    api-versions            # 所有可用的apiVersion
    config                  # 设置集群
        config set current-context c1
    plugin                  # 设置插件
    version
Basic Commands:
    create
        -f y1.yml
    expose                          # 修改端口
        expose deployment/[deployName]
        --target-port=8080 
        --type=NodePort
    run   
        run [deployName] 
        --image=gcr.io/google-samples/hello-app:1.0
        --port=8080
    set                             # 更新配置
        set image deploy/[deployName] *=image1:1.1
            # 所有镜像更新为image1:1.1
    explain                         # 查resource文档
        pv
    get
        -o                          # 格式
            yaml
            wide
            jsonpath=&#39;{.items[0].metadata.name}&#39;
        -l app=a1                   # select label
        -c gateway
        --show-labels
        --selector app=a1
        --all-containers=true
    edit                            # 修改配置
        edit ingress ingress1
    delete 
        --force  
        --grace-period=0
Deploy Commands:
    rollout
        history deploy/deploy1
        pause deploy/deploy1
        restart
        resume deploy/deploy1
        status 
        undo deploy/deploy1         # 回滚到上一版本
    scale
        scale deploy/deploy1
            --replicas=1
    autoscale
        autoscale deploy/deploy1
            --min=1
            --max=3
            --cpu-percent=80
Cluster Management Commands:
    certificate
        approve [csrName]           # 手动签发证书，/etc/kubernetes/ssl/*
        deny
    cluster-info                    # 集群信息 
        dump
    top                             # cpu 内存负载
        node
        pod
    cordon [nodeName]               # node不可调度
    uncordon                        # node可调度
    drain [nodeName]                # 移除node
    taint                           # node污点
        taint nodes node1 key1=val1:NoSchedule
Troubleshooting and Debugging Commands:
    describe     
    logs
    attach                          # 当前终端成为entrypoint
    exec         
        -it device-7b8965d85d-xz4qm bash
        -it device-7b8965d85d-xz4qm --container device -- /bin/bash
    port-forward                    # 端口映射
        port-forward [podName] 本地端口:pod端口
    proxy                           # 映射ApiServer到本地端口
        --port=8080
    cp                              # copy容器文件
        cp [namespaceName]/[podName]:[filePath] .
    auth         
        can-i list pods             # judge权限
        reconcile -f rbac.yaml      # 应用权限配置
            --dry-run               # 仅测试，列出变更
            --remove-extra-subjects         # 删除除外subject
            --remove-extra-permissions      # 删除除外权限
    debug                           # pod调试模式, alpha版功能，需要--feature-gates=&quot;EphemeralContainers=true&quot;
        -it pod1 
        --image=image1              # 排错工具镜像
        --share-processes           # 共享进程
        --copy-to=pod1-debug
Advanced Commands:
    diff      
        diff -f a.yml               # dry run 找出将实行的变更
    apply           # 升级
        -f y1.yml
        -k overlays/
    patch                           # 更新属性
        patch deploy/deploy1
        -p &#39;{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}&#39;
    replace                         # 替换resource
        replace -f a.yml
    wait                            # 等待直到满足条件
        -f a.yml
        --for=condition=Available
        --timeout=1h
    kustomize                       # 多环境部署的overlays补丁
        kustomize [dir with kustomization.yml]
Settings Commands:
    label
        label pods/pod1 a=b
        --overwrite                 # 覆盖更新
        --resource-version=1        # 匹配没修改过的情况
    annotate
        annotate pods/pod1 a=&#39;b&#39;
        --overwrite
    completion                      # 生成终端命令补全配置
        completion bash &gt; /etc/bash_completion.d/kubectl


  Helm
  #

目录
    charts/
    Chart.yaml
        apiVersion: v1
        appVersion: &quot;1.0&quot;
        description: A Helm chart for Kubernetes
        name: nginx-test
        version: 0.1.0
    requirements.yaml
    requirements.lock
    values.yaml
        replicaCount: 1
    templates/
        _helpers.tpl
        deployment.yaml
    
helm命令
    查看
        ls/list
            --all-namespaces
        get values a1                   # 查看已部署的values变更
        history  a1                     # 查看历史版本
        get manifest a1                 # 查看已安装模板
        template                        # 查看编译后内容
            --debug
        search repo a1 
            --versions
    安装
        repo
            update
        install [deployName] [packageName|packageFile|packagePath] 
            -f values.yaml
            --values=values.yaml
            --set a=b
        upgrade                         # 热更新部署文件
            --debug --dry-run           # 只输出编译结果
            -i                          # 没有时执行install
            --disable-openapi-validation
        uninstall
    插件
        plugin
            install --version master https://gitee.com/mirrors_sonatype-nexus-community/helm-nexus-push.git
            ls
    运维
        rollback a1 1                   # 回滚到1版本
    打包
        create a1
        lint --strict a1                # 校验
        package a1                      # 打包成a1-0.1.0.tgz

相关命令


  minikube
  #

docker login --username=934260428@qq.com registry.cn-hangzhou.aliyuncs.com
命令
    minikube
        start --vm-driver=virtualbox \
            --memory=4096 \
            --cpus=2 \
            --log_dir=/home/outrun/logs \
            --insecure-registry=192.168.99.1:5000 \
            --insecure-registry=registry.cn-qingdao.aliyuncs.com \
            --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers

            --kubernetes-version v1.17.0
            --docker-env=HTTP_PROXY=$HTTP_PROXY \
            --docker-env=HTTPS_PROXY=$HTTPS_PROXY \
            --docker-env=NO_PROXY=$NO_PROXY \
            --image-mirror-country=cn \
            --registry-mirror=https://registry.docker-cn.com \
            --extra-config=kubelet.MaxPods=5.
                # registry一定是minikube容器ip, 可用ifconfig查看
                # --insecure-registry修改需要minikube delete
        stop
        delete
        status 
        docker-env
        ip      # 得到单机集群ip
        service  -n iot mosquitto --url
            # 得到service的nodePort

        ssh
        dashboard
        addons
            list
            enable heapster
            enable ingress
服务
    kube-system
        coredns
        etcd-minikube
        kube-addon-manager-minikube
        kube-proxy
        kube-scheduler-minikube
        nginx-ingress-controller
        storage-provisioner
    kubernetes-dashboard
        dashboard-metrics-scraper
        kubernetes-dashboard


  平台
  #

HPE Container Platform
OpenShift
VMware VSphere
Minikube
Rancher
KubeSphere
Google Cloud Platform(GCP)
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://ukeate.com/docs/tool/ops/k8s/">
  <meta property="og:site_name" content="ukeate的笔记">
  <meta property="og:title" content="Kubernetes">
  <meta property="og:description" content="常用 # 查看 # 系统日志 journalctl -u kubelet | tail kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -nmdw 日志 kubectl logs -f --since=5m --all-containers=true -lapp=[svcName] -o wide kubectl get pod [podName] -o yaml kubectl get pods -nmdw-log -l app=logstash-logstash -w # 等待启动 kubectl describe pods [podName] kubectl rollout status deploy/[deployName] # 查升级记录 kubectl get events -njnc -oyaml --field-selector=type=Normal # Normal, Warning 查ns所有资源 kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -nairflow 查节点详情 kubectl get nodes -o json 查扩缩状态 kubectl rollout status deploy/[deployName] 查所有nodeport kubectl get svc --all-namespaces -o go-template=&#39;{{range .items}}{{range.spec.ports}}{{if .nodePort}}{{.nodePort}}{{&#34;\n&#34;}}{{end}}{{end}}{{end}}&#39; 操作 # 进容器 kubectl exec -it [podName] -- /bin/bash kubectl attach [podName] # 进入主进程IO 用busybox运行命令 kubectl run -it --image busybox -n [nameSpace] [name] --restart=Never --rm 监控 # kubectl top node -l app=app1 kubectl top pod -nmdw --containers kubectl describe PodMetrics p1 -njnc-dev 编辑 # kubectl apply -f a.yml envsubst &lt; jnc.yml |kubectl apply -f - kubectl label ns jnc istio-injection=enabled --overwrite kubectl label ns jnc istio-injection- 亲和性 # kubectl get nodes --show-labels kubectl label nodes node1 deploy=mdw kubectl taint nodes node1 key=value:NoSchedule # NoSchedule、PreferNoSchedule、NoExecute 调试 # kubectl proxy --port=8080 &amp; # 以非https形式暴露api kubectl debug a1 -it --image=yauritux/busybox-curl --share-processes --copy-to=a1-debug # 嫁接 kubectl run -it --rm test --image=a:0.1.0 --command -- /bin/bash # 改镜像命令 kubectl run -it --rm busybox1 --image=yauritux/busybox-curl -- /bin/bash # 同环境busybox kubectl cp dir1 ns1/po1:/dir1 -c c1 清理 # 删除Evicted/OutOfmemory pod kubectl get po -njnc-dev | grep OutOfmemory |awk &#39;{print$1}&#39; | tr &#39;\n&#39; &#39;&#39; | xargs kubectl delete pod -njnc-dev 强制删除pod kubectl delete po -nmdw --force --grace-period=0 删除pv/pvc kubectl patch pv mdw-mysql-data -p &#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:null}}&#39; 重建pv kubectl get pvc p1 -o yaml &gt; a.yml 编辑a.yml kubectl apply -f a.yml 删除node kubectl drain node1 维护node不可调度与恢复 kubectl cordon node1 kubectl uncordon node1 强制删除ns kubectl get ns n1 -o json &gt;tmp.json 删除finalizers列表 kubectl proxy curl -k -H &#34;Content-Type: application/json&#34; -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/n1/finalize 操作 # 升级镜像 kubectl set image deploy/[deployName] [imageName]=[imageName:Version] kubectl edit deploy/[deployName] 扩容 kubectl scale deployment [deployName] --replicas=3 kubectl patch deployment [deployName] -p &#39;{&#34;spec&#34;:{&#34;replicas&#34;:3}}&#39; 重启 kubectl rollout restart deploy xxx 回滚 kubectl rollout undo deploy xxx 打污点 kubectl taint nodes node1 key1=a:NoExecute # 添加 kubectl taint nodes --all key1- # 删除 打标签 kubectl label nodes node1 a=b 容器配置 # HTTPS openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout tls.key -out tls.crt -subj &#34;/CN=my-domain.com&#34; kubectl create secret tls my-domain-com-tls --cert=tls.crt --key=tls.key --namespace=allure-docker-service ingress.yml spec: tls: - secretName: my-domain-com-tls hosts: - my-domain.com 部署.docker/config.json成secret kubectl create secret generic regcred --from-file=.dockerconfigjson=&lt;path/to/.docker/config.json&gt; --type=kubernetes.io/dockerconfigjson 配置私有仓库 kubectl delete secret local kubectl -n iot create secret docker-registry local1 \ --docker-server=192.168.99.1:5000 \ --docker-username=outrun \ --docker-password=asdf \ --docker-email=934260428@qq.com 连阿里云k8s kubectl config set-cluster mrs --server=https://106.14.49.217:6443 --certificate-authority=/home/outrun/scripts/work/mrs-k8s/crt --embed-certs=true kubectl config set-context 297351062922226746-cdf45d630b2284f8ab79bea186c161d9f --cluster=mrs --user=297351062922226746 --namespace=lora-app kubectl config use-context 297351062922226746-cdf45d630b2284f8ab79bea186c161d9f kubectl config set-credentials 297351062922226746 --user=297351062922226746 --client-key=/home/outrun/scripts/work/mrs-k8s/297351062922226746.key.pem --client-certificate=/home/outrun/scripts/work/mrs-k8s/297351062922226746.crt --embed-certs=true 集群配置 # 设置当前集群namespace kubectl config set-context $(kubectl config current-context) --namespace=default 配置DNS解析 kubectl edit configmap coredns -n kube-system apiVersion: v1 data: Corefile: | .:53 { errors hosts { 192.168.1.107 a.b.com } } kubectl rollout restart deploy coredns -n kube-system 文件目录 # /etc/kubernetes /etc/resolve.conf 命令 # kubeadm # kubeadm init kubectl # 全局参数 --help # -h --output=&#34;jsonpath={.data.\.dockerconfigjson}&#34; --output=yaml --context=iot --namespace=iot --all-namespaces=true -n [namespace] --all # 如匹配所有deploy文件 Other Commands api-resources # 查所有resource namespace/ns endpoints/ep nodes/no configmap/cm replicationcontrollers/rc deployments/deploy statefulsets/sts service/svc ingresses/ing persistentvolumes/pv persistentvolumeclaims/pvc storageclasses/sc pods/po cronjobs/cj daemonset/ds # 每个node运行一个 certificatesigningrequests/csr # csr证书 api-versions # 所有可用的apiVersion config # 设置集群 config set current-context c1 plugin # 设置插件 version Basic Commands: create -f y1.yml expose # 修改端口 expose deployment/[deployName] --target-port=8080 --type=NodePort run run [deployName] --image=gcr.io/google-samples/hello-app:1.0 --port=8080 set # 更新配置 set image deploy/[deployName] *=image1:1.1 # 所有镜像更新为image1:1.1 explain # 查resource文档 pv get -o # 格式 yaml wide jsonpath=&#39;{.items[0].metadata.name}&#39; -l app=a1 # select label -c gateway --show-labels --selector app=a1 --all-containers=true edit # 修改配置 edit ingress ingress1 delete --force --grace-period=0 Deploy Commands: rollout history deploy/deploy1 pause deploy/deploy1 restart resume deploy/deploy1 status undo deploy/deploy1 # 回滚到上一版本 scale scale deploy/deploy1 --replicas=1 autoscale autoscale deploy/deploy1 --min=1 --max=3 --cpu-percent=80 Cluster Management Commands: certificate approve [csrName] # 手动签发证书，/etc/kubernetes/ssl/* deny cluster-info # 集群信息 dump top # cpu 内存负载 node pod cordon [nodeName] # node不可调度 uncordon # node可调度 drain [nodeName] # 移除node taint # node污点 taint nodes node1 key1=val1:NoSchedule Troubleshooting and Debugging Commands: describe logs attach # 当前终端成为entrypoint exec -it device-7b8965d85d-xz4qm bash -it device-7b8965d85d-xz4qm --container device -- /bin/bash port-forward # 端口映射 port-forward [podName] 本地端口:pod端口 proxy # 映射ApiServer到本地端口 --port=8080 cp # copy容器文件 cp [namespaceName]/[podName]:[filePath] . auth can-i list pods # judge权限 reconcile -f rbac.yaml # 应用权限配置 --dry-run # 仅测试，列出变更 --remove-extra-subjects # 删除除外subject --remove-extra-permissions # 删除除外权限 debug # pod调试模式, alpha版功能，需要--feature-gates=&#34;EphemeralContainers=true&#34; -it pod1 --image=image1 # 排错工具镜像 --share-processes # 共享进程 --copy-to=pod1-debug Advanced Commands: diff diff -f a.yml # dry run 找出将实行的变更 apply # 升级 -f y1.yml -k overlays/ patch # 更新属性 patch deploy/deploy1 -p &#39;{&#34;spec&#34;:{&#34;unschedulable&#34;:true}}&#39; replace # 替换resource replace -f a.yml wait # 等待直到满足条件 -f a.yml --for=condition=Available --timeout=1h kustomize # 多环境部署的overlays补丁 kustomize [dir with kustomization.yml] Settings Commands: label label pods/pod1 a=b --overwrite # 覆盖更新 --resource-version=1 # 匹配没修改过的情况 annotate annotate pods/pod1 a=&#39;b&#39; --overwrite completion # 生成终端命令补全配置 completion bash &gt; /etc/bash_completion.d/kubectl Helm # 目录 charts/ Chart.yaml apiVersion: v1 appVersion: &#34;1.0&#34; description: A Helm chart for Kubernetes name: nginx-test version: 0.1.0 requirements.yaml requirements.lock values.yaml replicaCount: 1 templates/ _helpers.tpl deployment.yaml helm命令 查看 ls/list --all-namespaces get values a1 # 查看已部署的values变更 history a1 # 查看历史版本 get manifest a1 # 查看已安装模板 template # 查看编译后内容 --debug search repo a1 --versions 安装 repo update install [deployName] [packageName|packageFile|packagePath] -f values.yaml --values=values.yaml --set a=b upgrade # 热更新部署文件 --debug --dry-run # 只输出编译结果 -i # 没有时执行install --disable-openapi-validation uninstall 插件 plugin install --version master https://gitee.com/mirrors_sonatype-nexus-community/helm-nexus-push.git ls 运维 rollback a1 1 # 回滚到1版本 打包 create a1 lint --strict a1 # 校验 package a1 # 打包成a1-0.1.0.tgz 相关命令 minikube # docker login --username=934260428@qq.com registry.cn-hangzhou.aliyuncs.com 命令 minikube start --vm-driver=virtualbox \ --memory=4096 \ --cpus=2 \ --log_dir=/home/outrun/logs \ --insecure-registry=192.168.99.1:5000 \ --insecure-registry=registry.cn-qingdao.aliyuncs.com \ --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version v1.17.0 --docker-env=HTTP_PROXY=$HTTP_PROXY \ --docker-env=HTTPS_PROXY=$HTTPS_PROXY \ --docker-env=NO_PROXY=$NO_PROXY \ --image-mirror-country=cn \ --registry-mirror=https://registry.docker-cn.com \ --extra-config=kubelet.MaxPods=5. # registry一定是minikube容器ip, 可用ifconfig查看 # --insecure-registry修改需要minikube delete stop delete status docker-env ip # 得到单机集群ip service -n iot mosquitto --url # 得到service的nodePort ssh dashboard addons list enable heapster enable ingress 服务 kube-system coredns etcd-minikube kube-addon-manager-minikube kube-proxy kube-scheduler-minikube nginx-ingress-controller storage-provisioner kubernetes-dashboard dashboard-metrics-scraper kubernetes-dashboard 平台 # HPE Container Platform OpenShift VMware VSphere Minikube Rancher KubeSphere Google Cloud Platform(GCP)">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2018-10-11T18:18:21+08:00">
    <meta property="article:modified_time" content="2022-11-11T15:49:15+08:00">
<title>Kubernetes | ukeate的笔记</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://ukeate.com/docs/tool/ops/k8s/">
<link rel="stylesheet" href="/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.583fa0f4b9042b18aff2c52da52cf49a4f5a6745f9e09453d85a938cfec8ee01.js" integrity="sha256-WD&#43;g9LkEKxiv8sUtpSz0mk9aZ0X54JRT2FqTjP7I7gE=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  <script data-ad-client="ca-pub-6239994681364905" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<meta name="baidu_union_verify" content="aacbc30462cce84b2333063d99284e3b">
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" class="book-icon" /><span>ukeate的笔记</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/" class="">基本功</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/speach/" class="">演说</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/body/" class="">身体</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/computer/" class="">Computer</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/computer/principle/" class="">支撑-原理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/computer/performance/" class="">Performance</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/algorithm/" class="">算法</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/algorithm/thought/" class="">算法思想</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/algorithm/data_structure/" class="">数据结构</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/basic/algorithm/math/" class="">数学</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/" class="">架构</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/code/" class="">代码</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/code/security/" class="">Security</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/code/design_mode/" class="">Java设计模式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/project/" class="">工程设计</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/project/ddd/" class="">工程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/project/frontend/" class="">前端</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>战略性技术</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/ai/" class="">AI</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/ai/map/" class="">知识图谱</a>
  

        </li>
      
    
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/iot/" class="">IoT</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/iot/framework/" class="">Framework</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/meta/" class="">IoT</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/meta/media/" class="">媒体</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/middle_platform/" class="">中台</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/block_chain/" class="">Block Chain</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Cloud</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/datalake/" class="">Datalake</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/datalake/ecology/" class="">Ecology</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/strategy/edge/" class="">Edge</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/manage/" class="">Manage</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/manage/organize/" class="">组织</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/manage/organize/people/" class="">人员</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/" class="">Method</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/product_plan/" class="">产品规划</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/code_plan/" class="">代码规划</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/ops_plan/" class="">运维规划</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/advice_plan/" class="">咨询规划</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/architect/" class="">服务治理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/project_plan/" class="">项目规划</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/method/test_plan/" class="">测试规划</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/architect/summary/" class="">这些年我做过的技术</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/" class="">程序语言</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/principle/" class="">程序语言原理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/haskell/" class="">Haskell</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/elixir/" class="">Elixir</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/go/" class="">Go</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/python/" class="">Python</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/clojure/" class="">Clojure</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/js/" class="">JS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/" class="">Java</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/java_reactive/" class="">Java响应式编程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/javaweb/" class="">JavaWeb</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/juc/" class="">Java并发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/jvm/" class="">JVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/collection/" class="">Collection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/java/spring/" class="">Spring</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/markup_language/" class="">Markup Language</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/markup_language/html/" class="">Html</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/pl/markup_language/css/" class="">Css</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/" class="">工具</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/ops/" class="">运维</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/ops/monitor/" class="">Monitor</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/ops/docker/" class="">Docker</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/ops/k8s/" class="active">Kubernetes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/product/enterprise_system/" class="">企业级系统</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/develop/" class="">Develop</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/develop/eclipse/" class="">Eclipse</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/develop/vim/" class="">VIM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/develop/apple/" class="">Apple</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/develop/jetbrains/" class="">Jetbrains</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/linux/" class="">Linux</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/linux/linux_program/" class="">LinuxProgram</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/linux/scene/" class="">LinuxScene</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/linux/linux_tool/" class="">LinuxTool</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/product/framework/" class="">Framework</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/physics/" class="">实物工具</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/test/" class="">测试</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tool/test/debug/" class="">程序调试</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/db/" class="">数据库</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/db/mongodb/" class="">Mongodb</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/db/postgresql/" class="">Postgre SQL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/db/elasticsearch/" class="">Elasticsearch</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/db/mysql/" class="">Mysql</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/db/oracle/" class="">Oracle</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/db/redis/" class="">Redis</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/" class="">中间件</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/distributed/" class="">支撑-分布式</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/distributed/spring_cloud/" class="">Spring Cloud</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library_frontend/" class="">前端</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library_frontend/bootstrap/" class="">Bootstrap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library_frontend/threejs/" class="">Threejs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library_frontend/angular/" class="">Angular</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library_frontend/jquery/" class="">Jquery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library_frontend/react/" class="">React</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library/" class="">小功能</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/library/hibernate/" class="">Hibernate</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Container</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/container/nginx/" class="">Nginx</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/middleware/container/nodejs/" class="">Nodejs</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cache/" class="">Cache</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/cache/ops/" class="">Ops</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cache/work_code/" class="">Work Code</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cache/template/" class="">模板配置</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cache/soft_arch/" class="">软考架构师</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/misc/" class="">杂项</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>










  
<ul>
  
  <li>
    <a href="/posts/"  >
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Kubernetes</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#常用">常用</a>
      <ul>
        <li><a href="#查看">查看</a></li>
        <li><a href="#操作">操作</a></li>
        <li><a href="#监控">监控</a></li>
        <li><a href="#编辑">编辑</a></li>
        <li><a href="#亲和性">亲和性</a></li>
        <li><a href="#调试">调试</a></li>
        <li><a href="#清理">清理</a></li>
        <li><a href="#操作-1">操作</a></li>
        <li><a href="#容器配置">容器配置</a></li>
        <li><a href="#集群配置">集群配置</a></li>
      </ul>
    </li>
    <li><a href="#文件目录">文件目录</a></li>
    <li><a href="#命令">命令</a>
      <ul>
        <li><a href="#kubeadm">kubeadm</a></li>
        <li><a href="#kubectl">kubectl</a></li>
      </ul>
    </li>
    <li><a href="#helm">Helm</a></li>
    <li><a href="#minikube">minikube</a></li>
    <li><a href="#平台">平台</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="常用">
  常用
  <a class="anchor" href="#%e5%b8%b8%e7%94%a8">#</a>
</h1>
<h2 id="查看">
  查看
  <a class="anchor" href="#%e6%9f%a5%e7%9c%8b">#</a>
</h2>
<pre><code>系统日志
    journalctl -u kubelet | tail
    kubectl api-resources --verbs=list --namespaced -o name   | xargs -n 1 kubectl get --show-kind --ignore-not-found -nmdw
日志
    kubectl logs -f --since=5m --all-containers=true -lapp=[svcName] -o wide
    kubectl get pod [podName] -o yaml
    kubectl get pods -nmdw-log -l app=logstash-logstash -w    # 等待启动
    kubectl describe pods [podName]
    kubectl rollout status deploy/[deployName]          # 查升级记录
    kubectl get events -njnc
        -oyaml
        --field-selector=type=Normal            # Normal, Warning
查ns所有资源
    kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -nairflow
查节点详情
    kubectl get nodes -o json
查扩缩状态
    kubectl rollout status deploy/[deployName]
查所有nodeport
    kubectl get svc --all-namespaces -o go-template='{{range .items}}{{range.spec.ports}}{{if .nodePort}}{{.nodePort}}{{&quot;\n&quot;}}{{end}}{{end}}{{end}}'
</code></pre>
<h2 id="操作">
  操作
  <a class="anchor" href="#%e6%93%8d%e4%bd%9c">#</a>
</h2>
<pre><code>进容器
    kubectl exec -it [podName]  -- /bin/bash
    kubectl attach [podName]            # 进入主进程IO
用busybox运行命令
    kubectl run -it --image busybox -n [nameSpace] [name] --restart=Never --rm
</code></pre>
<h2 id="监控">
  监控
  <a class="anchor" href="#%e7%9b%91%e6%8e%a7">#</a>
</h2>
<pre><code>kubectl top node -l app=app1
kubectl top pod -nmdw --containers
kubectl describe PodMetrics p1 -njnc-dev
</code></pre>
<h2 id="编辑">
  编辑
  <a class="anchor" href="#%e7%bc%96%e8%be%91">#</a>
</h2>
<pre><code>kubectl apply -f a.yml
envsubst &lt; jnc.yml |kubectl apply -f -
kubectl label ns jnc istio-injection=enabled --overwrite
kubectl label ns jnc istio-injection-
</code></pre>
<h2 id="亲和性">
  亲和性
  <a class="anchor" href="#%e4%ba%b2%e5%92%8c%e6%80%a7">#</a>
</h2>
<pre><code>kubectl get nodes --show-labels
kubectl label nodes node1 deploy=mdw
kubectl taint nodes node1 key=value:NoSchedule                      # NoSchedule、PreferNoSchedule、NoExecute
</code></pre>
<h2 id="调试">
  调试
  <a class="anchor" href="#%e8%b0%83%e8%af%95">#</a>
</h2>
<pre><code>kubectl proxy --port=8080 &amp;
    # 以非https形式暴露api
kubectl debug a1 -it --image=yauritux/busybox-curl --share-processes --copy-to=a1-debug
    # 嫁接
kubectl run -it --rm test --image=a:0.1.0 --command -- /bin/bash
    # 改镜像命令
kubectl run -it --rm  busybox1 --image=yauritux/busybox-curl -- /bin/bash
    # 同环境busybox
kubectl cp dir1 ns1/po1:/dir1 -c c1
</code></pre>
<h2 id="清理">
  清理
  <a class="anchor" href="#%e6%b8%85%e7%90%86">#</a>
</h2>
<pre><code>删除Evicted/OutOfmemory pod
    kubectl get po -njnc-dev | grep OutOfmemory |awk '{print$1}' | tr '\n' '' | xargs kubectl delete pod -njnc-dev
强制删除pod
    kubectl delete po -nmdw --force --grace-period=0
删除pv/pvc
    kubectl patch pv mdw-mysql-data -p '{&quot;metadata&quot;:{&quot;finalizers&quot;:null}}'
重建pv
    kubectl get pvc p1 -o yaml &gt; a.yml
    编辑a.yml
    kubectl apply -f a.yml
删除node
    kubectl drain node1
维护node不可调度与恢复
    kubectl cordon node1
    kubectl uncordon node1
强制删除ns
    kubectl get ns n1 -o json &gt;tmp.json
    删除finalizers列表
    kubectl proxy
    curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/n1/finalize
</code></pre>
<h2 id="操作-1">
  操作
  <a class="anchor" href="#%e6%93%8d%e4%bd%9c-1">#</a>
</h2>
<pre><code>升级镜像
    kubectl set image deploy/[deployName] [imageName]=[imageName:Version]
    kubectl edit deploy/[deployName]
扩容
    kubectl scale deployment [deployName] --replicas=3
    kubectl patch deployment [deployName] -p '{&quot;spec&quot;:{&quot;replicas&quot;:3}}'
重启
    kubectl rollout restart deploy xxx
回滚
    kubectl rollout undo deploy xxx
打污点
    kubectl taint nodes node1 key1=a:NoExecute
        # 添加
    kubectl taint nodes --all key1-
        # 删除
打标签
    kubectl label nodes node1 a=b
</code></pre>
<h2 id="容器配置">
  容器配置
  <a class="anchor" href="#%e5%ae%b9%e5%99%a8%e9%85%8d%e7%bd%ae">#</a>
</h2>
<pre><code>HTTPS
    openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout tls.key -out tls.crt -subj &quot;/CN=my-domain.com&quot;
    kubectl create secret tls my-domain-com-tls --cert=tls.crt --key=tls.key --namespace=allure-docker-service
    ingress.yml
        spec:
            tls:
            - secretName: my-domain-com-tls
              hosts:
                - my-domain.com
              
部署.docker/config.json成secret
    kubectl create secret generic regcred --from-file=.dockerconfigjson=&lt;path/to/.docker/config.json&gt; --type=kubernetes.io/dockerconfigjson
配置私有仓库
    kubectl delete secret local
    kubectl -n iot create secret docker-registry local1 \
    --docker-server=192.168.99.1:5000 \
    --docker-username=outrun \
    --docker-password=asdf \
    --docker-email=934260428@qq.com
连阿里云k8s
    kubectl config set-cluster mrs --server=https://106.14.49.217:6443 --certificate-authority=/home/outrun/scripts/work/mrs-k8s/crt --embed-certs=true
    kubectl config set-context 297351062922226746-cdf45d630b2284f8ab79bea186c161d9f --cluster=mrs --user=297351062922226746 --namespace=lora-app
    kubectl config use-context 297351062922226746-cdf45d630b2284f8ab79bea186c161d9f
    kubectl config set-credentials 297351062922226746  --user=297351062922226746 --client-key=/home/outrun/scripts/work/mrs-k8s/297351062922226746.key.pem --client-certificate=/home/outrun/scripts/work/mrs-k8s/297351062922226746.crt --embed-certs=true
</code></pre>
<h2 id="集群配置">
  集群配置
  <a class="anchor" href="#%e9%9b%86%e7%be%a4%e9%85%8d%e7%bd%ae">#</a>
</h2>
<pre><code>设置当前集群namespace
    kubectl config set-context $(kubectl config current-context) --namespace=default
配置DNS解析
    kubectl edit configmap coredns -n kube-system
        apiVersion: v1
        data:
        Corefile: |
            .:53 {
                errors
                hosts {
                    192.168.1.107 a.b.com
                }
            }
    kubectl rollout restart deploy coredns -n kube-system
</code></pre>
<h1 id="文件目录">
  文件目录
  <a class="anchor" href="#%e6%96%87%e4%bb%b6%e7%9b%ae%e5%bd%95">#</a>
</h1>
<pre><code>/etc/kubernetes
/etc/resolve.conf
</code></pre>
<h1 id="命令">
  命令
  <a class="anchor" href="#%e5%91%bd%e4%bb%a4">#</a>
</h1>
<h2 id="kubeadm">
  kubeadm
  <a class="anchor" href="#kubeadm">#</a>
</h2>
<pre><code>kubeadm init
</code></pre>
<h2 id="kubectl">
  kubectl
  <a class="anchor" href="#kubectl">#</a>
</h2>
<pre><code>全局参数
    --help                  # -h
    --output=&quot;jsonpath={.data.\.dockerconfigjson}&quot;
    --output=yaml
    --context=iot
    --namespace=iot 
    --all-namespaces=true
    -n [namespace] 
    --all                           # 如匹配所有deploy文件
Other Commands
    api-resources           # 查所有resource
        namespace/ns
        endpoints/ep
        nodes/no
        configmap/cm  
        replicationcontrollers/rc
        deployments/deploy
        statefulsets/sts
        service/svc 
        ingresses/ing
        persistentvolumes/pv
        persistentvolumeclaims/pvc
        storageclasses/sc
        pods/po
        cronjobs/cj
        daemonset/ds                    # 每个node运行一个
        certificatesigningrequests/csr  # csr证书
    api-versions            # 所有可用的apiVersion
    config                  # 设置集群
        config set current-context c1
    plugin                  # 设置插件
    version
Basic Commands:
    create
        -f y1.yml
    expose                          # 修改端口
        expose deployment/[deployName]
        --target-port=8080 
        --type=NodePort
    run   
        run [deployName] 
        --image=gcr.io/google-samples/hello-app:1.0
        --port=8080
    set                             # 更新配置
        set image deploy/[deployName] *=image1:1.1
            # 所有镜像更新为image1:1.1
    explain                         # 查resource文档
        pv
    get
        -o                          # 格式
            yaml
            wide
            jsonpath='{.items[0].metadata.name}'
        -l app=a1                   # select label
        -c gateway
        --show-labels
        --selector app=a1
        --all-containers=true
    edit                            # 修改配置
        edit ingress ingress1
    delete 
        --force  
        --grace-period=0
Deploy Commands:
    rollout
        history deploy/deploy1
        pause deploy/deploy1
        restart
        resume deploy/deploy1
        status 
        undo deploy/deploy1         # 回滚到上一版本
    scale
        scale deploy/deploy1
            --replicas=1
    autoscale
        autoscale deploy/deploy1
            --min=1
            --max=3
            --cpu-percent=80
Cluster Management Commands:
    certificate
        approve [csrName]           # 手动签发证书，/etc/kubernetes/ssl/*
        deny
    cluster-info                    # 集群信息 
        dump
    top                             # cpu 内存负载
        node
        pod
    cordon [nodeName]               # node不可调度
    uncordon                        # node可调度
    drain [nodeName]                # 移除node
    taint                           # node污点
        taint nodes node1 key1=val1:NoSchedule
Troubleshooting and Debugging Commands:
    describe     
    logs
    attach                          # 当前终端成为entrypoint
    exec         
        -it device-7b8965d85d-xz4qm bash
        -it device-7b8965d85d-xz4qm --container device -- /bin/bash
    port-forward                    # 端口映射
        port-forward [podName] 本地端口:pod端口
    proxy                           # 映射ApiServer到本地端口
        --port=8080
    cp                              # copy容器文件
        cp [namespaceName]/[podName]:[filePath] .
    auth         
        can-i list pods             # judge权限
        reconcile -f rbac.yaml      # 应用权限配置
            --dry-run               # 仅测试，列出变更
            --remove-extra-subjects         # 删除除外subject
            --remove-extra-permissions      # 删除除外权限
    debug                           # pod调试模式, alpha版功能，需要--feature-gates=&quot;EphemeralContainers=true&quot;
        -it pod1 
        --image=image1              # 排错工具镜像
        --share-processes           # 共享进程
        --copy-to=pod1-debug
Advanced Commands:
    diff      
        diff -f a.yml               # dry run 找出将实行的变更
    apply           # 升级
        -f y1.yml
        -k overlays/
    patch                           # 更新属性
        patch deploy/deploy1
        -p '{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}'
    replace                         # 替换resource
        replace -f a.yml
    wait                            # 等待直到满足条件
        -f a.yml
        --for=condition=Available
        --timeout=1h
    kustomize                       # 多环境部署的overlays补丁
        kustomize [dir with kustomization.yml]
Settings Commands:
    label
        label pods/pod1 a=b
        --overwrite                 # 覆盖更新
        --resource-version=1        # 匹配没修改过的情况
    annotate
        annotate pods/pod1 a='b'
        --overwrite
    completion                      # 生成终端命令补全配置
        completion bash &gt; /etc/bash_completion.d/kubectl
</code></pre>
<h1 id="helm">
  Helm
  <a class="anchor" href="#helm">#</a>
</h1>
<pre><code>目录
    charts/
    Chart.yaml
        apiVersion: v1
        appVersion: &quot;1.0&quot;
        description: A Helm chart for Kubernetes
        name: nginx-test
        version: 0.1.0
    requirements.yaml
    requirements.lock
    values.yaml
        replicaCount: 1
    templates/
        _helpers.tpl
        deployment.yaml
    
helm命令
    查看
        ls/list
            --all-namespaces
        get values a1                   # 查看已部署的values变更
        history  a1                     # 查看历史版本
        get manifest a1                 # 查看已安装模板
        template                        # 查看编译后内容
            --debug
        search repo a1 
            --versions
    安装
        repo
            update
        install [deployName] [packageName|packageFile|packagePath] 
            -f values.yaml
            --values=values.yaml
            --set a=b
        upgrade                         # 热更新部署文件
            --debug --dry-run           # 只输出编译结果
            -i                          # 没有时执行install
            --disable-openapi-validation
        uninstall
    插件
        plugin
            install --version master https://gitee.com/mirrors_sonatype-nexus-community/helm-nexus-push.git
            ls
    运维
        rollback a1 1                   # 回滚到1版本
    打包
        create a1
        lint --strict a1                # 校验
        package a1                      # 打包成a1-0.1.0.tgz

相关命令
</code></pre>
<h1 id="minikube">
  minikube
  <a class="anchor" href="#minikube">#</a>
</h1>
<pre><code>docker login --username=934260428@qq.com registry.cn-hangzhou.aliyuncs.com
命令
    minikube
        start --vm-driver=virtualbox \
            --memory=4096 \
            --cpus=2 \
            --log_dir=/home/outrun/logs \
            --insecure-registry=192.168.99.1:5000 \
            --insecure-registry=registry.cn-qingdao.aliyuncs.com \
            --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers

            --kubernetes-version v1.17.0
            --docker-env=HTTP_PROXY=$HTTP_PROXY \
            --docker-env=HTTPS_PROXY=$HTTPS_PROXY \
            --docker-env=NO_PROXY=$NO_PROXY \
            --image-mirror-country=cn \
            --registry-mirror=https://registry.docker-cn.com \
            --extra-config=kubelet.MaxPods=5.
                # registry一定是minikube容器ip, 可用ifconfig查看
                # --insecure-registry修改需要minikube delete
        stop
        delete
        status 
        docker-env
        ip      # 得到单机集群ip
        service  -n iot mosquitto --url
            # 得到service的nodePort

        ssh
        dashboard
        addons
            list
            enable heapster
            enable ingress
服务
    kube-system
        coredns
        etcd-minikube
        kube-addon-manager-minikube
        kube-proxy
        kube-scheduler-minikube
        nginx-ingress-controller
        storage-provisioner
    kubernetes-dashboard
        dashboard-metrics-scraper
        kubernetes-dashboard
</code></pre>
<h1 id="平台">
  平台
  <a class="anchor" href="#%e5%b9%b3%e5%8f%b0">#</a>
</h1>
<pre><code>HPE Container Platform
OpenShift
VMware VSphere
Minikube
Rancher
KubeSphere
Google Cloud Platform(GCP)
</code></pre>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/outrunJ/hugo-blog/commit/dd93d5ad93ecf665f57c227c7ae8e043d0db2625" title='Last modified by outrun | Nov 11, 2022' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="" />
      <span>Nov 11, 2022</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/outrunJ/hugo-blog/tree/master/content/content/docs/tool/ops/k8s.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#常用">常用</a>
      <ul>
        <li><a href="#查看">查看</a></li>
        <li><a href="#操作">操作</a></li>
        <li><a href="#监控">监控</a></li>
        <li><a href="#编辑">编辑</a></li>
        <li><a href="#亲和性">亲和性</a></li>
        <li><a href="#调试">调试</a></li>
        <li><a href="#清理">清理</a></li>
        <li><a href="#操作-1">操作</a></li>
        <li><a href="#容器配置">容器配置</a></li>
        <li><a href="#集群配置">集群配置</a></li>
      </ul>
    </li>
    <li><a href="#文件目录">文件目录</a></li>
    <li><a href="#命令">命令</a>
      <ul>
        <li><a href="#kubeadm">kubeadm</a></li>
        <li><a href="#kubectl">kubectl</a></li>
      </ul>
    </li>
    <li><a href="#helm">Helm</a></li>
    <li><a href="#minikube">minikube</a></li>
    <li><a href="#平台">平台</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












